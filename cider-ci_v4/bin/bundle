#!/usr/bin/env bash
set -eux
export PATH=~/.rubies/$RUBY/bin:$PATH

if [ ! -d ~/.rubies/$RUBY ]; then
  ruby-install --no-install-deps $RUBY_ENGINE $RUBY_VERSION
fi

if [ ! -f ~/.rubies/$RUBY/bin/bundle ]; then
  gem install bundler
fi

DIGEST=$(git ls-tree HEAD --\
  cider-ci_v3.yml cider-ci_v4 Gemfile.lock \
  | openssl dgst -sha1 | cut -d ' ' -f 2)

DIGEST=$(echo "$DIGEST $PATH" \
 | openssl dgst -sha1 | cut -d ' ' -f 2)

CACHE_SIGNATURE_FILE="/tmp/bundle_cache_signature_${DIGEST}"

if [ ! -f  $CACHE_SIGNATURE_FILE ] ; then
  bundle install
  touch $CACHE_SIGNATURE_FILE
fi
